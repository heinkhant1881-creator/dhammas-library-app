// --- Dhamma Data (Updated with Full Text Content and Links) ---
const dhammaTopics = [
    { 
        title: 'မဂ္ဂင်ရှစ်ပါး (Noble Eightfold Path)', 
        author: 'ဗုဒ္ဓဓမ္မ', 
        category: 'Basic', 
        year: 'N/A', 
        text: 
            `ပဋိပဒါ ခေါ် မဂ္ဂင်ရှစ်ပါးသည် ဒုက္ခချုပ်ငြိမ်းရာ နိဗ္ဗာန်သို့ ရောက်ကြောင်း လမ်းကောင်း ဖြစ်သည်။

I. ပညာမဂ္ဂင် (Wisdom Factors)
၁။ သမ္မာဒိဋ္ဌိ (Right View) - ကံ၊ ကံ၏ အကျိုးကို ယုံကြည်ခြင်း။ အရိယသစ္စာတရား လေးပါးကို သိမြင်ခြင်း။
၂။ သမ္မာသင်္ကပ္ပ (Right Thought) - ကာမဝိတက်၊ ဗျာပါဒဝိတက်၊ ဝိဟိံသာဝိတက်တို့မှ ကင်းသော နေက္ခမ္မဝိတက်၊ အဗျာပါဒဝိတက်၊ အဝိဟိံသာဝိတက်တို့ ဖြစ်ခြင်း။

II. သီလမဂ္ဂင် (Moral Factors)
၃။ သမ္မာဝါစာ (Right Speech) - မဟုတ်မမှန် ပြောဆိုခြင်း၊ ကြမ်းတမ်းစွာ ပြောဆိုခြင်း၊ ကုန်းတိုက်ခြင်း၊ ပြိန်ဖျင်းသော စကား ပြောဆိုခြင်းတို့မှ ရှောင်ကြဉ်ခြင်း။
၄။ သမ္မာကမ္မန္တ (Right Action) - သူတစ်ပါး အသက်ကို သတ်ခြင်း၊ ခိုးယူခြင်း၊ ကာမဂုဏ်ကို မှားယွင်းစွာ ကျင့်ခြင်းတို့မှ ရှောင်ကြဉ်ခြင်း။
၅။ သမ္မာအာဇီဝ (Right Livelihood) - အသက်မွေးဝမ်းကျောင်း မှားယွင်းမှုမှ ရှောင်ကြဉ်ခြင်း (ဓမ္မနှင့်အညီ ရိုးသားစွာ အသက်မွေးခြင်း)။

III. သမာဓိမဂ္ဂင် (Concentration Factors)
၆။ သမ္မာဝါယာမ (Right Effort) - ဖြစ်ပြီးသော အကုသိုလ်ကို ပယ်ရန်၊ မဖြစ်သေးသော အကုသိုလ်ကို မဖြစ်စေရန်၊ မဖြစ်သေးသော ကုသိုလ်ကို ဖြစ်ပေါ်စေရန်၊ ဖြစ်ပြီးသော ကုသိုလ်ကို တိုးပွားစေရန် ကြိုးစားခြင်း။
၇။ သမ္မာသတိ (Right Mindfulness) - ကာယာနုပဿနာ၊ ဝေဒနာနုပဿနာ၊ စိတ္တာနုပဿနာ၊ ဓမ္မာနုပဿနာဟူသော သတိပဋ္ဌာန်တရားလေးပါးကို ရှုမှတ်ခြင်း။
၈။ သမ္မာသမာဓိ (Right Concentration) - ဈာန်တရားများဖြင့် စိတ်ကို တည်ငြိမ်စေခြင်း။
        `
    },
    { 
        title: 'ပဋိစ္စသမုပ္ပါဒ် (Dependent Origination)', 
        author: 'မဟာစည် ဆရာတော်', 
        category: 'Abhidhamma', 
        year: 1965, 
        text: 
            `မူရင်းပါဠိတော်မှ အကျဉ်းချုပ် - 
            "အဝိဇ္ဇာပစ္စယာ သင်္ခါရာ၊ သင်္ခါရပစ္စယာ ဝိညာဏံ..." 
            
            ၁။ အဝိဇ္ဇာ (မသိမှု) ကြောင့် သင်္ခါရ (ပြုပြင်စီရင်မှု) ဖြစ်သည်။
            ၂။ သင်္ခါရ ကြောင့် ဝိညာဉ် (အာရုံသိစိတ်) ဖြစ်သည်။
            ၃။ ဝိညာဉ် ကြောင့် နာမ်ရုပ် (စိတ်နှင့် ရုပ်ခန္ဓာ) ဖြစ်သည်။
            ၄။ နာမ်ရုပ် ကြောင့် သဠာယတန (အာရုံခြောက်ပါး) ဖြစ်သည်။
            ၅။ သဠာယတန ကြောင့် ဖဿ (တွေ့ထိမှု) ဖြစ်သည်။
            ၆။ ဖဿ ကြောင့် ဝေဒနာ (ခံစားမှု) ဖြစ်သည်။
            ၇။ ဝေဒနာ ကြောင့် တဏှာ (လိုချင်တပ်မက်မှု) ဖြစ်သည်။
            ၈။ တဏှာ ကြောင့် ဥပါဒါန် (စွဲလမ်းမှု) ဖြစ်သည်။
            ၉။ ဥပါဒါန် ကြောင့် ဘဝ (ကမ္မဘဝ) ဖြစ်သည်။
            ၁၀။ ဘဝ ကြောင့် ဇာတိ (ပဋိသန္ဓေနေရခြင်း) ဖြစ်သည်။
            ၁၁။ ဇာတိ ကြောင့် ဇရာမရဏ (အိုခြင်း၊ သေခြင်း) ဖြစ်သည်။

            ထို့ကြောင့် ဒုက္ခအပေါင်း၏ အကြောင်းရင်းကို သိခြင်းသည် ပဋိစ္စသမုပ္ပါဒ်ကို သိခြင်းပင် ဖြစ်သည်။` 
    },
    { 
        title: 'အနတ္တလက္ခဏာသုတ် (Anattalakkhaṇa Sutta)', 
        author: 'မြတ်စွာဘုရား', 
        category: 'Sutta', 
        year: 'N/A', 
        text: 
            `ခန္ဓာငါးပါး အနတ္တတရားကို ဟောကြားတော်မူခြင်း (ပါဠိတော်နှင့် အနက်အဓိပ္ပာယ် အကျဉ်းချုပ်)
            
            "ရူပံ ဘိက္ခဝေ အနတ္တာ။ ဝေဒနာ အနတ္တာ။ သညာ အနတ္တာ။ သင်္ခါရာ အနတ္တာ။ ဝိညာဏံ အနတ္တာ။"
            (ချစ်သားတို့၊ ရုပ်သည် အတ္တမဟုတ်၊ ဝေဒနာသည် အတ္တမဟုတ်၊ သညာသည် အတ္တမဟုတ်၊ သင်္ခါရတို့သည် အတ္တမဟုတ်၊ ဝိညာဉ်သည် အတ္တမဟုတ်။)

            အတ္တ (ကိုယ်၊ ငါ့ဟာ၊ ငါ) မဟုတ်ကြောင်းကို ခန္ဓာငါးပါးဖြင့် ရှင်းပြတော်မူသည်။
            ၁။ ရုပ် (Form)
            ၂။ ဝေဒနာ (Feeling)
            ၃။ သညာ (Perception)
            ၄။ သင်္ခါရ (Mental Formations)
            ၅။ ဝိညာဉ် (Consciousness)

            ဤခန္ဓာငါးပါးတို့သည် ဖောက်ပြန်ပျက်စီးတတ်သောကြောင့် အနိစ္စ (မမြဲခြင်း)၊ ဆင်းရဲဒုက္ခနှင့် ကြုံတွေ့ရသောကြောင့် ဒုက္ခ (ဆင်းရဲခြင်း)၊ အစိုးမရဘဲ ပျက်စီးသွားသောကြောင့် အနတ္တ (အတ္တမဟုတ်ခြင်း) ဟူ၍ ရှုမှတ်ရမည်။`
    },
    { 
        title: 'ဒါန၊ သီလ၊ ဘာဝနာ (Generosity, Virtue, Meditation)', 
        author: 'ဗုဒ္ဓဓမ္မ', 
        category: 'Basic', 
        year: 'N/A', 
        text: 
            `မြတ်ဗုဒ္ဓ၏ အခြေခံ ကောင်းမှုကုသိုလ်သုံးပါး -

            ၁။ ဒါန (ပေးလှူခြင်း)
            ပစ္စည်းဥစ္စာ၊ အစားအစာ စသည်တို့ကို လိုအပ်သူတို့အား စေတနာရှေ့ထား၍ ပေးကမ်းစွန့်ကြဲခြင်း ဖြစ်သည်။ စိတ်၏ တွယ်တာမှုနှင့် လောဘကို လျော့ပါးစေသည်။

            ၂။ သီလ (ကိုယ်ကျင့်သီလ)
            ကိုယ်၊ နှုတ်၊ စိတ်တို့ကို စောင့်စည်းထိန်းသိမ်းခြင်း ဖြစ်သည်။ လူ့ဘောင်တွင် အခြေခံအကျဆုံးမှာ ငါးပါးသီလ ဖြစ်သည်။ သူတစ်ပါးကို မထိခိုက်အောင် နေထိုင်ခြင်းဖြင့် ဘေးကင်းမှုကို ပေးသည်။

            ၃။ ဘာဝနာ (ပွားများခြင်း)
            စိတ်ကို ကောင်းမွန်အောင် ပြုပြင်မွမ်းမံခြင်း ဖြစ်သည်။ သမထဘာဝနာ (စိတ်ငြိမ်အောင်) နှင့် ဝိပဿနာဘာဝနာ (ဓမ္မကို သိအောင်) ဟူ၍ နှစ်မျိုးရှိသည်။ ဉာဏ်ပညာ တိုးတက်စေသော အမြင့်မြတ်ဆုံး ကုသိုလ်ဖြစ်သည်။`
    },
    {
        title: 'နိဗ္ဗာန်နှင့် သံသရာ (Nibbana and Samsara)',
        author: 'အရှင်ဇနကာဘိဝံသ',
        category: 'Abhidhamma',
        year: 1980,
        text: `နိဗ္ဗာန်သည် ရာဂ၊ ဒေါသ၊ မောဟ တို့၏ ချုပ်ငြိမ်းရာ၊ လုံးဝငြိမ်းအေးရာ ဖြစ်သည်။ သံသရာဆိုသည်မှာ ထိုကိလေသာတို့၏ လွှမ်းမိုးမှုကြောင့် အသစ်အသစ် မွေးဖွားခြင်း၊ အိုခြင်း၊ သေခြင်းဟူသော ဘဝများတွင် လည်ပတ်နေခြင်း ဖြစ်သည်။ နိဗ္ဗာန်သည် သံသရာ၏ ဆန့်ကျင်ဘက် အမြဲတည်မြဲသော တရား ဖြစ်သည်။`
    },
    {
        title: 'ဗုဒ္ဓဝင် အကျဉ်းချုပ် (Short Biography of the Buddha)',
        author: 'Various Sources',
        category: 'History',
        year: 'N/A',
        text: `ဘုရားအလောင်းတော် သိဒ္ဓတ္ထမင်းသား ဖွားတော်မူခြင်း၊ လေးပြင်ကြည့်ခြင်း၊ တောထွက်တော်မူခြင်း၊ ခြောက်နှစ် ဒုက္ကရစရိယာကျင့်တော်မူခြင်း၊ ဘုရားအဖြစ်သို့ ရောက်တော်မူခြင်းနှင့် ပရိနိဗ္ဗာန် ဝင်စံတော်မူခြင်းတို့ ပါဝင်သည်။`
    }
];

const categories = ['Basic', 'Sutta', 'Abhidhamma', 'History', 'Resources']; // Resources ကဏ္ဍ ထပ်ထည့်မည်

// --- External Resources Data (New Section) ---
const externalResources = [
    { name: 'ဓမ္မဒါနစာပေ (Dhamma Dana)', link: 'https://dhammadana.info/', description: 'စာအုပ်များ အခမဲ့ Download ရယူရန်' },
    { name: 'Tipitaka Pali Canon', link: 'https://www.tipitaka.org/', description: 'မူရင်း ပိဋကတ်တော်များ လေ့လာရန်' },
    { name: 'MoeGok Web (မိုးကုတ်)', link: 'http://www.moegok.net/', description: 'မိုးကုတ်တရားတော်များ နာယူရန်' },
    { name: 'Vipassana Research (Sayadaw U Janaka)', link: 'http://www.satipatthana.info/', description: 'ဝိပဿနာ ကျင့်စဉ်များ လေ့လာရန်' }
];

// --- DOM Elements (Existing) ---
const appFrame = document.getElementById('appFrame');
const mainContent = document.getElementById('mainContent');
const navButtons = document.querySelectorAll('.nav-btn');
const detailModal = document.getElementById('detailModal');
const detailTitle = document.getElementById('detailTitle');
const detailText = document.getElementById('detailText');
const settingsModal = document.getElementById('settingsModal');
const darkModeToggle = document.getElementById('darkModeToggle');
const languageSelect = document.getElementById('languageSelect');
const fontStyleSelect = document.getElementById('fontStyleSelect');

// --- State Variables (Existing) ---
let currentLanguage = 'myanmar';

// --- Core App Rendering Functions ---

// renderHomePage and renderBookList functions remain mostly the same, 
// but ensure the search input is properly re-attached after re-rendering.

function renderHomePage(books) {
    mainContent.innerHTML = `
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="${currentLanguage === 'myanmar' ? 'ဓမ္မခေါင်းစဉ်များ ရှာဖွေပါ...' : 'Search Dhamma Topics or Suttas...'}" oninput="filterBooks()">
            <i class="fas fa-search search-icon"></i>
        </div>
        <div id="bookList" class="book-list"></div>
    `;
    renderBookList(books);
    
    // Re-attach filterBooks function to the new input element
    const newSearchInput = document.getElementById('searchInput');
    if (newSearchInput) {
        newSearchInput.addEventListener('input', filterBooks);
    }
}

function renderBookList(books) {
    const bookListEl = document.getElementById('bookList');
    if (!bookListEl) return;
    
    bookListEl.innerHTML = ''; 
    
    if (books.length === 0) {
        bookListEl.innerHTML = `<p style="text-align: center; color: #777; padding: 20px;">${currentLanguage === 'myanmar' ? 'ရှာဖွေသော ဓမ္မခေါင်းစဉ် မတွေ့ပါ' : 'No Dhamma topics found'}</p>`;
        return;
    }

    books.forEach(book => {
        const item = document.createElement('div');
        item.className = 'book-item';
        item.innerHTML = `
            <h3>${book.title}</h3>
            <p style="font-size: 0.85em; color: #999;">${currentLanguage === 'myanmar' ? 'ကဏ္ဍ' : 'Category'}: ${book.category} | ${book.author}</p>
            <button class="read-btn">${currentLanguage === 'myanmar' ? 'အသေးစိတ် ဖတ်ရန်' : 'Read Detail'}</button>
        `;
        
        // Event Listener for Read Detail
        item.querySelector('.read-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            showDetailModal(book.title, book.text);
        });

        // Event Listener for Card click (same as detail)
        item.addEventListener('click', () => showDetailModal(book.title, book.text));

        bookListEl.appendChild(item);
    });
}


function renderCategoriesPage() {
    mainContent.innerHTML = `<h2 style="color: var(--primary-color); margin-top: 0;">${currentLanguage === 'myanmar' ? 'ဓမ္မကဏ္ဍများ' : 'Dhamma Categories'}</h2>`;
    
    categories.forEach(cat => {
        const isResource = cat === 'Resources';
        
        const card = document.createElement('div');
        card.className = 'category-card';
        card.innerHTML = `
            <h3><i class="fas fa-folder"></i> ${cat}</h3>
            ${isResource 
                ? `<p style="color: #666; font-size: 0.9em;">${currentLanguage === 'myanmar' ? 'အွန်လိုင်း လေ့လာစရာများ' : 'Online Learning Resources'}</p>`
                : `<p style="color: #666; font-size: 0.9em;">${dhammaTopics.filter(t => t.category === cat).length} ${currentLanguage === 'myanmar' ? 'ပုဒ်' : 'Topics'}</p>`
            }
        `;
        card.addEventListener('click', () => {
            if (isResource) {
                // If Resources, render the resource list
                renderResourcesPage();
                setActiveNav('categories'); // Stay on categories tab
            } else {
                // Filter topics by category
                const filtered = dhammaTopics.filter(t => t.category === cat);
                setActiveNav('home');
                renderHomePage(filtered);
                alert(`${cat} ${currentLanguage === 'myanmar' ? 'ကဏ္ဍမှ ဓမ္မခေါင်းစဉ်များ ပြသပါမည်။' : 'Category topics displayed.'}`);
            }
        });
        mainContent.appendChild(card);
    });
}

function renderResourcesPage() {
    mainContent.innerHTML = `<h2 style="color: var(--danger-color); margin-top: 0;">${currentLanguage === 'myanmar' ? '⭐ အွန်လိုင်း ဓမ္မရင်းမြစ်များ' : '⭐ Online Dhamma Resources'}</h2>`;
    
    externalResources.forEach(res => {
        const item = document.createElement('div');
        item.className = 'book-item'; // Reusing book-item style for consistency
        item.style.borderLeftColor = '#9E1010'; // Red accent for links
        item.innerHTML = `
            <h3>${res.name} <i class="fas fa-external-link-alt" style="font-size: 0.8em; margin-left: 5px;"></i></h3>
            <p style="color: #666;">${res.description}</p>
            <button class="read-btn" onclick="window.open('${res.link}', '_blank')">${currentLanguage === 'myanmar' ? 'ဝက်ဘ်ဆိုက် ဖွင့်ရန်' : 'Open Website'}</button>
        `;
        mainContent.appendChild(item);
    });
}


// --- All other functions (renderProfilePage, setActiveNav, Modal Handlers, filterBooks, Settings, Initialization) 
// --- remain the same as the previous code. Please ensure you copy the entire JS code block for full functionality.

// --- Search Functionality (Re-declared for global scope access) ---
function filterBooks() {
    const searchInput = document.getElementById('searchInput');
    if (!searchInput) return; 
    
    const searchTerm = searchInput.value.toLowerCase();
    
    const filteredBooks = dhammaTopics.filter(book => {
        return book.title.toLowerCase().includes(searchTerm) || 
               book.author.toLowerCase().includes(searchTerm) ||
               book.category.toLowerCase().includes(searchTerm);
    });

    renderBookList(filteredBooks);
}

// ... (Copy all remaining functions from the previous JS code block: initializeApp, event listeners for Nav, Modals, and Settings) ...
// The rest of the JS code for Modals, Settings, and Initialization goes here.

// Note: Due to the complexity of including all previous and new functions in one response, 
// please ensure you combine this new code block with the previous JS code's remaining parts 
// (especially Modal Handlers, Settings Logic, and initializeApp function) in CodePen.

// --- Initialization (Load Saved Settings & Start App) ---
function initializeApp() {
    // Load Dark Mode setting
    if (localStorage.getItem('darkMode') === 'enabled') {
        appFrame.classList.add('dark-mode');
        darkModeToggle.checked = true;
    }
    
    // Load Language setting
    currentLanguage = localStorage.getItem('language') || 'myanmar';
    languageSelect.value = currentLanguage;

    // Load Notifications setting
    const notifStatus = localStorage.getItem('notifications') === 'ON' ? true : false;
    document.getElementById('notificationsToggle').checked = notifStatus;

    // Load Font Style setting
    const savedFont = localStorage.getItem('fontStyle') || 'default';
    fontStyleSelect.value = savedFont;
    if (savedFont !== 'default') {
        appFrame.classList.add(`font-${savedFont}`);
    }

    // Start with the Home page
    renderHomePage(dhammaTopics);
}

// --- Navigation & Page Management (Existing) ---
function setActiveNav(page) {
    navButtons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.getAttribute('data-page') === page) {
            btn.classList.add('active');
        }
    });
}

navButtons.forEach(button => {
    button.addEventListener('click', function() {
        const page = this.getAttribute('data-page');
        setActiveNav(page);
        
        if (page === 'home') {
            renderHomePage(dhammaTopics);
        } else if (page === 'categories') {
            renderCategoriesPage();
        } else if (page === 'profile') {
            renderProfilePage();
        }
    });
});

// --- Modal Handlers (Existing) ---
function showDetailModal(title, text) {
    detailTitle.textContent = title;
    detailText.textContent = text;
    detailModal.style.display = 'block';
}

function closeModal(modalElement) {
    modalElement.style.display = 'none';
}

// Close Modals when the user clicks on (x) or outside the modal
document.querySelectorAll('.close-btn').forEach(btn => {
    btn.addEventListener('click', () => closeModal(btn.closest('.modal')));
});
window.onclick = function(event) {
    if (event.target == detailModal) { closeModal(detailModal); }
    if (event.target == settingsModal) { closeModal(settingsModal); }
}

// --- Settings Component Styling (Existing) ---
function renderProfilePage() {
    mainContent.innerHTML = `
        <div class="profile-card" style="text-align: center; padding: 20px; background: var(--card-bg); border-radius: 12px; margin-top: 20px;">
            <i class="fas fa-user-circle" style="font-size: 4em; color: var(--accent-color);"></i>
            <h3 style="margin: 10px 0;">Dhamma Seeker</h3>
            <p style="color: #666;">Member since: 2024</p>
            <button id="openSettingsBtn" class="read-btn" style="background-color: var(--primary-color);"><i class="fas fa-cog"></i> ${currentLanguage === 'myanmar' ? 'ချိန်ညှိချက်များ' : 'Settings'}</button>
        </div>
    `;
    document.getElementById('openSettingsBtn').addEventListener('click', () => settingsModal.style.display = 'block');
}

// 1. Dark Mode Toggle
darkModeToggle.addEventListener('change', function() {
    if (this.checked) {
        appFrame.classList.add('dark-mode');
        localStorage.setItem('darkMode', 'enabled');
    } else {
        appFrame.classList.remove('dark-mode');
        localStorage.setItem('darkMode', 'disabled');
    }
});

// 2. Language Change
languageSelect.addEventListener('change', function() {
    currentLanguage = this.value;
    alert(`${currentLanguage === 'myanmar' ? 'ဘာသာစကား ပြောင်းလဲလိုက်ပါပြီ။' : 'Language changed to ' + currentLanguage + '.'}`);
    localStorage.setItem('language', currentLanguage);
    
    document.querySelector('.nav-btn.active').click();
});

// 3. Notifications Toggle (Simulated)
document.getElementById('notificationsToggle').addEventListener('change', function() {
    const status = this.checked ? 'ON' : 'OFF';
    alert(`Notifications set to ${status}`);
    localStorage.setItem('notifications', status);
});

// 4. Font Style Change
fontStyleSelect.addEventListener('change', function() {
    appFrame.classList.remove('font-serif', 'font-monospace');
    if (this.value === 'serif') {
        appFrame.classList.add('font-serif');
    } else if (this.value === 'monospace') {
        appFrame.classList.add('font-monospace');
    }
    localStorage.setItem('fontStyle', this.value);
});


initializeApp();
