// --- 1. Dhamma Data (V2.0: Detailed and complete topics) ---
const dhammaTopics = [
    { 
        title: 'မဂ္ဂင်ရှစ်ပါး (Noble Eightfold Path)', 
        author: 'ဗုဒ္ဓဓမ္မ', 
        category: 'Basic', 
        year: 'N/A', 
        text: 
            `မဂ္ဂင်ရှစ်ပါးသည် ဒုက္ခချုပ်ငြိမ်းရာ နိဗ္ဗာန်သို့ ရောက်ကြောင်း လမ်းကောင်း (မဇ္ဈိမပဋိပဒါ) ဖြစ်သည်။

I. ပညာမဂ္ဂင် (Wisdom Factors)
၁။ သမ္မာဒိဋ္ဌိ (Right View): အရိယသစ္စာလေးပါး (ဒုက္ခ၊ ဒုက္ခသမုဒယ၊ ဒုက္ခနိရောဓ၊ ဒုက္ခနိရောဓဂါမိနီ ပဋိပဒါ) တို့ကို မှန်ကန်စွာ သိမြင်ခြင်း။ ကံနှင့် ကံ၏အကျိုးကို ယုံကြည်ခြင်း။
၂။ သမ္မာသင်္ကပ္ပ (Right Thought): နိဗ္ဗာန်သို့ ဦးတည်သော နေက္ခမ္မ (ထွက်မြောက်လိုစိတ်)၊ အဗျာပါဒ (ဒေါသကင်းသော မေတ္တာစိတ်)၊ အဝိဟိံသာ (မညှင်းဆဲလိုသော ကရုဏာစိတ်) တို့ဖြင့် ကြံစည်ခြင်း။

II. သီလမဂ္ဂင် (Moral Factors)
၃။ သမ္မာဝါစာ (Right Speech): မုသာဝါဒ (လိမ်ပြောခြင်း)၊ ပိသုဏာဝါစာ (ကုန်းတိုက်ခြင်း)၊ ဖရုသာဝါစာ (ကြမ်းတမ်းသောစကား)၊ သမ္ဖပ္ပလာပ (အနှစ်မရှိသော စကား) တို့မှ ရှောင်ကြဉ်ခြင်း။
၄။ သမ္မာကမ္မန္တ (Right Action): ပါဏာတိပါတ (အသက်သတ်ခြင်း)၊ အဒိန္နာဒါန (သူ့ပစ္စည်း ခိုးယူခြင်း)၊ ကာမေသုမိစ္ဆာစာရ (ကာမဂုဏ်၌ မှားယွင်းစွာ ကျင့်ခြင်း) တို့မှ ရှောင်ကြဉ်ခြင်း။
၅။ သမ္မာအာဇီဝ (Right Livelihood): မှားယွင်းသော အသက်မွေးဝမ်းကျောင်းမှု (လက်နက်၊ အဆိပ်၊ လူ၊ သား၊ သေရည် ရောင်းဝယ်ခြင်း) မှ ရှောင်ကြဉ်ခြင်း။

III. သမာဓိမဂ္ဂင် (Concentration Factors)
၆။ သမ္မာဝါယာမ (Right Effort): မဖြစ်သေးသောအကုသိုလ်ကို မဖြစ်စေရန်၊ ဖြစ်ပြီးသောအကုသိုလ်ကို ပယ်ရန်၊ မဖြစ်သေးသောကုသိုလ်ကို ဖြစ်စေရန်၊ ဖြစ်ပြီးသောကုသိုလ်ကို တိုးပွားစေရန် လုံ့လ (ပဓာနိယဂင် ၄ ပါး)။
၇။ သမ္မာသတိ (Right Mindfulness): ကာယ၊ ဝေဒနာ၊ စိတ္တ၊ ဓမ္မ ဟူသော အာရုံလေးပါးတို့၌ သတိ (သတိပဋိပဋ္ဌာန် ၄ ပါး) ဖြင့် ရှုမှတ်ခြင်း။
၈။ သမ္မာသမာဓိ (Right Concentration): ဈာန်တရားလေးပါး (ပထမ၊ ဒုတိယ၊ တတိယ၊ စတုတ္ထ) တို့ကို ရရှိသည်အထိ စိတ်ကို တည်ငြိမ်အောင် ထားရှိခြင်း။
`
    },
    { 
        title: 'ပဋိစ္စသမုပ္ပါဒ် အင်္ဂါ (၁၂) ပါး (Dependent Origination)', 
        author: 'ဗုဒ္ဓဓမ္မ', 
        category: 'Abhidhamma', 
        year: 'N/A', 
        text: 
            `ပဋိစ္စသမုပ္ပါဒ်သည် သံသရာလည်ပတ်ပုံကို ပြသသော အကြောင်းအကျိုး ဆက်စပ်မှု (၁၂) ပါး ဖြစ်သည်။

၁။ အဝိဇ္ဇာပစ္စယာ သင်္ခါရာ (မသိမှုကြောင့် ပြုပြင်စီရင်မှုဖြစ်)
၂။ သင်္ခါရပစ္စယာ ဝိညာဏံ (ပြုပြင်မှုကြောင့် ဝိညာဉ်ဖြစ်)
၃။ ဝိညာဏပစ္စယာ နာမရူပံ (ဝိညာဉ်ကြောင့် နာမ်ရုပ်ဖြစ်)
၄။ နာမရူပပစ္စယာ သဠာယတနံ (နာမ်ရုပ်ကြောင့် အာရုံ (၆) ပါးဖြစ်)
၅။ သဠာယတနပစ္စယာ ဖေဿာ (အာရုံ (၆) ပါးကြောင့် တွေ့ထိမှုဖြစ်)
၆။ ဖဿပစ္စယာ ဝေဒနာ (တွေ့ထိမှုကြောင့် ခံစားမှုဖြစ်)
၇။ ဝေဒနာပစ္စယာ တဏှာ (ခံစားမှုကြောင့် တပ်မက်မှုဖြစ်)
၈။ တဏှာပစ္စယာ ဥပါဒါနံ (တပ်မက်မှုကြောင့် စွဲလမ်းမှုဖြစ်)
၉။ ဥပါဒါနပစ္စယာ ဘဝေါ (စွဲလမ်းမှုကြောင့် ကံဘဝဖြစ်)
၁၀။ ဘဝပစ္စယာ ဇာတိ (ကံဘဝကြောင့် ပဋိသန္ဓေနေရခြင်းဖြစ်)
၁၁။ ဇာတိပစ္စယာ ဇရာ (ပဋိသန္ဓေကြောင့် အိုခြင်းဖြစ်)
၁၂။ ဇရာပစ္စယာ မရဏံ (အိုခြင်းကြောင့် သေခြင်းဖြစ်)
`
    },
    { 
        title: 'မင်္ဂလာ (၃၈) ပါး (38 Blessings of Life)', 
        author: 'ဗုဒ္ဓဓမ္မ', 
        category: 'Sutta', 
        year: 'N/A', 
        text: 
            `မင်္ဂလာတရားတော် (၃၈) ပါးသည် လူသားတို့အတွက် အမြင့်ဆုံးသော ကောင်းကျိုးချမ်းသာကို ဖြစ်ထွန်းစေသော အကျင့်တရားများဖြစ်သည်။

၁။ အရိယာတို့ကို ဆည်းကပ်မှု။
၂။ မကောင်းသောသူတို့ကို မဆည်းကပ်မှု။
၃။ ပူဇော်ထိုက်သူကို ပူဇော်မှု။
၄။ သင့်လျော်သော အရပ်၌ နေမှု။
၅။ ရှေးကပြုဖူးသော ကောင်းမှုရှိမှု။
၆။ မိမိကိုယ်ကို ကောင်းစွာ ဆောက်တည်မှု။
၇။ အကြားအမြင်များမှု။
၈။ အတတ်ပညာတတ်မှု။
၉။ ကောင်းစွာ သင်ယူထားသော ဝိနယရှိမှု။
၁၀။ ကောင်းသောစကားကို ဆိုမှု။
၁၁။ မိဘကို လုပ်ကျွေးမှု။
၁၂။ သားမယားကို ကျွေးမွေးမှု။
၁၃။ အလုပ်တို့၌ မပျင်းရိမှု။
၁၄။ ပေးကမ်းလှူဒါန်းမှု။
၁၅။ ဓမ္မအကျင့်မြတ်ကို ကျင့်မှု။
၁၆။ ဆွေမျိုးတို့ကို စောင့်ရှောက်မှု။
၁၇။ အပြစ်ကင်းသော အမှုတို့ကို ပြုမှု။
၁၈။ မကောင်းမှုကို ရှောင်ကြဉ်မှု။
၁၉။ မူးယစ်သောက်စားခြင်းမှ ရှောင်ကြဉ်မှု။
၂၀။ တရားတို့၌ မမေ့မလျော့မှု။
၂၁။ အရိုအသေပြုမှု။
၂၂။ နှိမ့်ချသော စိတ်ရှိမှု။
၂၃။ ရောင့်ရဲလွယ်မှု။
၂၄။ ကျေးဇူးသိမှု။
၂၅။ သင့်လျော်သော အခါ၌ တရားနာမှု။
၂၆။ သင့်လျော်သော အခါ၌ တရားဆွေးနွေးမှု။
၂၇။ ခြိုးခြံသော တရားကျင့်မှု။
၂၈။ မြတ်သော အကျင့်ကို ကျင့်မှု။
၂၉။ အရိယသစ္စာကို မြင်ခြင်း။
၃၀။ နိဗ္ဗာန်ကို မျက်မှောက်ပြုခြင်း။
၃၁။ လောကဓံတရားတို့ဖြင့် တွေ့သော်လည်း မတုန်လှုပ်ခြင်း။
၃၂။ စိုးရိမ်မှု မရှိခြင်း။
၃၃။ ကိလေသာမှ ကင်းဝေးခြင်း။
၃၄။ ဘေးကင်းခြင်း။
၃၅။ မဂ်တရားကို ရခြင်း။
၃၆။ ဖိုလ်တရားကို ရခြင်း။
၃၇။ ကိလေသာတို့၏ ချုပ်ရာ နိဗ္ဗာန်ကို ရောက်ခြင်း။
၃၈။ ပြီးစီးအောင်မြင်သော အကျင့်ကို ကျင့်ခြင်း။
`
    },
    {
        title: 'ဗုဒ္ဓဘာသာ၏ ရတနာ (၃) ပါး (The Three Jewels)',
        author: 'ဗုဒ္ဓဓမ္မ',
        category: 'Basic',
        year: 'N/A',
        text: `ဗုဒ္ဓဘာသာဝင်တိုင်း ခိုလှုံရာ အမြတ်ဆုံး ရတနာသုံးပါးမှာ -
၁။ ဗုဒ္ဓံ (ဘုရားရှင်): အမှန်တရားကို ကိုယ်တိုင်သိ၍ သူတပါးအား သိအောင်ဟောကြားတော်မူသော ဆရာသမား။
၂။ ဓမ္မံ (တရားတော်): ဘုရားရှင် ဟောကြားတော်မူသည့် မဂ်၊ ဖိုလ်၊ နိဗ္ဗာန်သို့ ရောက်ကြောင်း လမ်းကောင်းတရားများ။
၃။ သံဃံ (သံဃာတော်): ဘုရားရှင်၏ တရားတော်ကို ကျင့်သုံး၍ မဂ်ဖိုလ်ကို ရရှိပြီး၊ လူအများအား လမ်းညွှန်ပေးသည့် ပုဂ္ဂိုလ်ထူးများ။
`
    },
    {
        title: 'ဒါန၊ သီလ၊ ဘာဝနာ (Generosity, Virtue, Meditation)',
        author: 'ဗုဒ္ဓဓမ္မ',
        category: 'Basic',
        year: 'N/A',
        text: `မြတ်ဗုဒ္ဓ၏ အခြေခံ ကောင်းမှုကုသိုလ်သုံးပါး (ပုညကိရိယဝတ္ထု သုံးပါး) ကို အသေးစိတ် လေ့လာခြင်း။

၁။ ဒါန (ပေးလှူခြင်း): လောဘနှင့် တွယ်တာမှုကို ပယ်သတ်ခြင်း၊ လာဘ်လာဘနှင့် ချမ်းသာကို ရရှိခြင်း။
၂။ သီလ (ကိုယ်ကျင့်သီလ): ကိုယ်၊ နှုတ်၊ စိတ်တို့ကို စောင့်စည်းထိန်းသိမ်းခြင်း၊ အကျိုးအားဖြင့် လုံခြုံမှု၊ ချမ်းသာမှု ရရှိခြင်း။
၃။ ဘာဝနာ (ပွားများခြင်း): စိတ်ကို ကောင်းမွန်အောင် ပြုပြင်မွမ်းမံခြင်း။ သမထ (စိတ်ငြိမ်စေရန်) နှင့် ဝိပဿနာ (ဖြစ်ပျက်သိရန်) ဟူ၍ နှစ်မျိုးရှိသည်။
`
    }
];

const categories = ['All', 'Basic', 'Sutta', 'Abhidhamma', 'History', 'Vinaya', 'Resources']; 

// --- 2. External Resources Data (Links are increased) ---
const externalResources = [
    { name: 'ပိဋကတ်တော် (Tipitaka)', link: 'https://www.tipitaka.org/', description: 'မူရင်း ပိဋကတ်တော်စာအုပ်များ (မြန်မာအစိုးရ)' },
    { name: 'ဓမ္မဒါနစာပေ (Dhamma Dana)', link: 'https://dhammadana.info/', description: 'တရားစာအုပ်များ အခမဲ့ Download ရယူရန်' },
    { name: 'MoeGok Web (မိုးကုတ်)', link: 'http://www.moegok.net/', description: 'မိုးကုတ်တရားတော်များ နာယူရန်' },
    { name: 'SuttaCentral (Pali/English)', link: 'https://suttacentral.net/', description: 'ပါဠိတော်များနှင့် အင်္ဂလိပ်ပြန်ဆိုချက်များ' },
    { name: 'Dhamma Talks by Sayadaw U Janaka', link: 'http://www.satipatthana.info/', description: 'ဝိပဿနာ ကျင့်စဉ်များနှင့် တရားတော်များ လေ့လာရန်' },
    { name: 'Ashin Thittila Dhamma Books', link: 'https://www.thittila.org/', description: 'အရှင်သီလာ၏ စာအုပ်များ' },
    { name: 'Dhammakami Sayadaw', link: 'https://dhammakami.com/', description: 'ဓမ္မကာမီ ဆရာတော်၏ တရားစာများ' }
];

// --- 3. DOM Elements & State Variables ---
const appFrame = document.getElementById('appFrame');
const mainContent = document.getElementById('mainContent');
const navButtons = document.querySelectorAll('.nav-btn');

// Detail Modal Elements
const detailModal = document.getElementById('detailModal');
const detailTitle = document.getElementById('detailTitle');
const detailText = document.getElementById('detailText');
const detailMeta = document.getElementById('detailMeta');
const detailCloseBtn = document.getElementById('closeDetail'); // Added ID for close button

// Settings Modal Elements
const settingsModal = document.getElementById('settingsModal');
const settingsCloseBtn = document.getElementById('closeSettings'); // Added ID for close button
const darkModeToggle = document.getElementById('darkModeToggle');
const languageSelect = document.getElementById('languageSelect');
const fontSizeSlider = document.getElementById('fontSizeSlider');

let aboutModal = null; // Will be created dynamically
let currentLanguage = localStorage.getItem('language') || 'myanmar';
let currentFilter = 'All';

// --- Modal Handling Functions ---
function showDetailModal(book) {
    detailTitle.textContent = book.title;
    detailText.textContent = book.text;
    detailMeta.innerHTML = `${currentLanguage === 'myanmar' ? 'အမျိုးအစား' : 'Category'}: <strong>${book.category}</strong> | ${currentLanguage === 'myanmar' ? 'ရေးသူ' : 'Author'}: <strong>${book.author}</strong>`;
    detailModal.style.display = 'block';
}

function closeModal(modalElement) {
    modalElement.style.display = 'none';
}

// Global click handler to close modals when clicking outside
window.addEventListener('click', (event) => {
    if (event.target === detailModal) {
        closeModal(detailModal);
    }
    if (event.target === settingsModal) {
        closeModal(settingsModal);
    }
    if (aboutModal && event.target === aboutModal) {
        closeModal(aboutModal);
    }
});

// Explicit close button handlers
if (detailCloseBtn) detailCloseBtn.addEventListener('click', () => closeModal(detailModal));
if (settingsCloseBtn) settingsCloseBtn.addEventListener('click', () => closeModal(settingsModal));


// --- Initial Setup and Local Storage Load ---

function loadSettings() {
    // 1. Dark Mode
    const savedDarkMode = localStorage.getItem('darkMode');
    if (savedDarkMode === 'enabled') {
        appFrame.classList.add('dark-mode');
        darkModeToggle.checked = true;
    } else {
        appFrame.classList.remove('dark-mode');
        darkModeToggle.checked = false;
    }

    // 2. Language
    const savedLanguage = localStorage.getItem('language');
    if (savedLanguage) {
        currentLanguage = savedLanguage;
        languageSelect.value = savedLanguage;
    }

    // 3. Font Size
    const savedFontSize = localStorage.getItem('fontSize');
    if (savedFontSize) {
        document.documentElement.style.setProperty('--base-font-size', savedFontSize + 'px');
        fontSizeSlider.value = savedFontSize;
    }
}

function initializeApp() {
    loadSettings();
    createAboutModal(); // Create the about modal once
    attachNavEvents(); // Attach event listeners to navigation buttons
    renderHomePage(dhammaTopics, currentFilter); // Start on the Home page
}
// --- 4. Core App Rendering Functions ---

function renderHomePage(books, currentFilter) {
    // Re-render Search/Tabs structure if needed
    // Check if the necessary structure is already present to avoid recreating on every filter
    const searchInput = document.getElementById('searchInput');
    const categoryTabs = document.getElementById('categoryTabsContainer');
    const bookList = document.getElementById('bookList');

    if (!searchInput || !categoryTabs || !bookList) {
        mainContent.innerHTML = `
            <div class="search-wrapper">
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" placeholder="${currentLanguage === 'myanmar' ? 'တရားတော်များ ရှာဖွေရန်...' : 'Search Dhamma Topics...'}" oninput="filterBooks()">
                </div>
            </div>
            <div id="categoryTabsContainer" class="category-tabs"></div>
            <div id="bookList" class="book-list"></div>
        `;
        // Re-attach filterBooks function after recreating the element
        document.getElementById('searchInput').addEventListener('input', filterBooks);
    } else {
        // Only update placeholder if structure exists (for language change)
        searchInput.placeholder = currentLanguage === 'myanmar' ? 'တရားတော်များ ရှာဖွေရန်...' : 'Search Dhamma Topics...';
    }
    
    renderCategoryTabs(currentFilter);
    renderBookList(books);
}

function renderBookList(books) {
    const bookListEl = document.getElementById('bookList');
    if (!bookListEl) return;
    
    bookListEl.innerHTML = ''; 
    
    if (books.length === 0) {
        bookListEl.innerHTML = `<p style="text-align: center; color: var(--text-light); padding: 20px;">${currentLanguage === 'myanmar' ? 'ရှာဖွေသော ဓမ္မခေါင်းစဉ် မတွေ့ပါ' : 'No Dhamma topics found'}</p>`;
        return;
    }

    books.forEach(book => {
        const item = document.createElement('div');
        item.className = 'book-item';
        item.innerHTML = `
            <h3>${book.title}</h3>
            <p style="font-size: 0.85em;">${currentLanguage === 'myanmar' ? 'အမျိုးအစား' : 'Category'}: ${book.category} | ${book.author}</p>
            
            <div class="book-actions" style="margin-top: 10px; display: flex; gap: 10px;">
                <button class="read-btn" style="background-color: var(--secondary-color);">${currentLanguage === 'myanmar' ? 'အသေးစိတ် ဖတ်ရန်' : 'Read Detail'}</button>
            </div>
        `;
        
        // Event Listener for Read Detail
        item.querySelector('.read-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            showDetailModal(book);
        });

        // Event Listener for Card click (same as detail)
        item.addEventListener('click', () => showDetailModal(book));

        bookListEl.appendChild(item);
    });
}

function renderCategoryTabs(activeCat) {
    const tabsContainer = document.getElementById('categoryTabsContainer');
    if (!tabsContainer) return;
    
    tabsContainer.innerHTML = '';
    categories.forEach(cat => {
        const button = document.createElement('button');
        button.className = `tab-btn ${cat === activeCat ? 'active' : ''}`;
        button.textContent = cat;
        button.addEventListener('click', () => filterByCategory(cat));
        tabsContainer.appendChild(button);
    });
    currentFilter = activeCat;
}

function renderResourcesPage() {
    mainContent.innerHTML = `<h2 style="color: var(--primary-color); margin-top: 0; text-align: center;"><i class="fas fa-link"></i> ${currentLanguage === 'myanmar' ? '⭐ အွန်လိုင်း ဓမ္မရင်းမြစ်များ' : '⭐ Online Dhamma Resources'}</h2>`;
    
    externalResources.forEach(res => {
        const item = document.createElement('div');
        item.className = 'resource-item book-item';
        item.style.borderLeftColor = 'var(--success-color)';
        item.innerHTML = `
            <h3>${res.name} <i class="fas fa-external-link-alt" style="font-size: 0.8em; margin-left: 5px;"></i></h3>
            <p style="color: var(--text-light);">${res.description}</p>
            <div style="margin-top: 10px;">
                <button class="read-btn" onclick="window.open('${res.link}', '_blank')" style="background-color: var(--success-color);">${currentLanguage === 'myanmar' ? 'ဝက်ဘ်ဆိုက် ဖွင့်ရန်' : 'Open Website'}</button>
            </div>
        `;
        mainContent.appendChild(item);
    });
}

// --- 5. About Modal Structure Creator ---
function createAboutModal() {
    // Only create if it doesn't exist
    if (aboutModal) {
        aboutModal.querySelector('#aboutContent').innerHTML = getAboutText();
        return;
    }
    
    aboutModal = document.createElement('div');
    aboutModal.id = 'aboutModal';
    aboutModal.className = 'modal';
    
    aboutModal.innerHTML = `
        <div class="modal-content animate-pop">
            <div class="modal-header">
                <h2><i class="fas fa-info-circle"></i> ${currentLanguage === 'myanmar' ? 'App အကြောင်း' : 'About App'}</h2>
                <span class="close-btn" id="closeAbout">&times;</span>
            </div>
            
            <div class="modal-body">
                <div id="aboutContent">
                    ${getAboutText()}
                </div>
                <p style="text-align: center; margin-top: 20px; font-size: 0.8em; color: var(--text-light);">
                    ${currentLanguage === 'myanmar' ? 'တည်ဆောက်သူ' : 'Developer'}: heinkhant1881-creator
                </p>
                <p style="text-align: center; font-size: 0.7em; color: var(--text-light);">
                    App Version 2.0 (Premium)
                </p>
            </div>
        </div>
    `;
    document.body.appendChild(aboutModal);

    // Attach listener to the close button inside the new modal
    document.getElementById('closeAbout').addEventListener('click', () => closeModal(aboutModal));
}

// --- 6. Content for the About Modal (Dynamic Translation) ---
function getAboutText() {
    return `
        <h3 style="color: var(--primary-color); text-align: center;">${currentLanguage === 'myanmar' ? '🙏 ဗုဒ္ဓဓမ္မ၏ အနှစ်သာရ 🙏' : '🙏 Essence of Dhamma 🙏'}</h3>
        <p>
            ${currentLanguage === 'myanmar' ? 
            `ဤ App သည် အခြေခံ ဗုဒ္ဓဘာသာ စာပေများ၊ သုတ္တန်များ၊ အဘိဓမ္မာ အကြောင်းအရာများ၊ ဗုဒ္ဓဝင်နှင့် ကျင့်ဝတ်များကို စုစည်းထားသော ဓမ္မစာကြည့်တိုက်ဖြစ်သည်။ ဒုက္ခချုပ်ငြိမ်းရာ နိဗ္ဗာန်သို့ ဦးတည်သော လမ်းညွှန်မှု ရရှိစေရန် ရည်ရွယ်ပါသည်။` :
            `This App is a Dhamma library collecting fundamental Buddhist literature, Suttas, Abhidhamma topics, history, and ethics. It is intended to provide guidance towards Nibbana, the cessation of suffering.`}
        </p>

        <h4 style="color: var(--accent-color); margin-top: 15px;">${currentLanguage === 'myanmar' ? 'အဓိက ကျင့်စဉ်များ' : 'Core Practices'}</h4>
        <ul style="padding-left: 20px; font-size: 0.95em;">
            <li><strong style="color: var(--secondary-color);">
                ${currentLanguage === 'myanmar' ? 'ဒါန' : 'Dāna (Generosity)'}
            </strong>: ${currentLanguage === 'myanmar' ? 'တွယ်တာစိတ် လျှော့ချခြင်း' : 'Reducing attachment.'}</li>
            <li><strong style="color: var(--secondary-color);">
                ${currentLanguage === 'myanmar' ? 'သီလ' : 'Sīla (Virtue)'}
            </strong>: ${currentLanguage === 'myanmar' ? 'ကိုယ်၊ နှုတ် တို့ကို စောင့်စည်းခြင်း' : 'Guarding body and speech.'}</li>
            <li><strong style="color: var(--secondary-color);">
                ${currentLanguage === 'myanmar' ? 'ဘာဝနာ' : 'Bhāvanā (Meditation)'}
            </strong>: ${currentLanguage === 'myanmar' ? 'စိတ်ကို ဖြူစင်အောင် ပွားများခြင်း' : 'Developing mental purity.'}</li>
        </ul>
    `;
}

// --- 7. Filtering and Search Logic ---

function filterByCategory(category) {
    currentFilter = category;
    
    // Deactivate all tabs and activate the clicked one
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    const activeTab = Array.from(document.querySelectorAll('.tab-btn')).find(btn => btn.textContent === category);
    if (activeTab) activeTab.classList.add('active');

    if (category === 'All') {
        renderBookList(dhammaTopics);
    } else {
        const filtered = dhammaTopics.filter(topic => topic.category === category);
        renderBookList(filtered);
    }
    
    // Clear search input when changing category
    const searchInput = document.getElementById('searchInput');
    if (searchInput) searchInput.value = '';
}

function filterBooks() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    // Reset category filter when searching
    currentFilter = 'All';
    renderCategoryTabs('All');
    
    if (searchTerm === '') {
        renderBookList(dhammaTopics);
        return;
    }
    
    const results = dhammaTopics.filter(book => 
        book.title.toLowerCase().includes(searchTerm) ||
        book.text.toLowerCase().includes(searchTerm) ||
        book.author.toLowerCase().includes(searchTerm)
    );
    
    renderBookList(results);
}
// --- 10. Navigation Logic (Handles view switching) ---
function handleNavigation(target) {
    // 1. Clear active state from all buttons
    navButtons.forEach(btn => btn.classList.remove('active'));

    // 2. Set active state on the clicked button
    const activeBtn = document.querySelector(`.nav-btn[data-target="${target}"]`);
    if (activeBtn) activeBtn.classList.add('active');

    // 3. Render the correct content
    mainContent.innerHTML = '';
    
    switch (target) {
        case 'home':
            renderHomePage(dhammaTopics, currentFilter);
            break;
        case 'resources':
            renderResourcesPage();
            break;
        case 'profile':
            renderProfilePage();
            break;
        default:
            renderHomePage(dhammaTopics, currentFilter);
    }
}

function attachNavEvents() {
    navButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            const target = btn.getAttribute('data-target');
            handleNavigation(target);
        });
    });
}

// --- 12. Profile Page Rendering ---
function renderProfilePage() {
    mainContent.innerHTML = `
        <div class="profile-card" style="text-align: center; padding: 25px; background: var(--bg-card); border-radius: var(--radius-lg); margin-top: 20px; box-shadow: var(--shadow-md);">
            <i class="fas fa-user-circle" style="font-size: 4.5em; color: var(--accent-color);"></i>
            <h3 style="margin: 10px 0; color: var(--primary-color);">Dhamma Seeker</h3>
            <p style="color: var(--text-light); font-size: 0.9em;">${currentLanguage === 'myanmar' ? 'ဓမ္မလေ့လာသူ' : 'Seeker'} (Vipassana Path)</p>
            
            <p style="font-size: 0.9em; color: var(--text-light); font-weight: 500; margin: 15px 0;">
                App Version 2.0 (Premium)
            </p>
            
            <div style="display: flex; justify-content: center; gap: 15px; margin-top: 20px;">
                <button id="openSettingsBtn" class="read-btn" style="background-color: var(--secondary-color); color: white;">
                    <i class="fas fa-cog"></i> ${currentLanguage === 'myanmar' ? 'ချိန်ညှိချက်များ' : 'Settings'}
                </button>
                
                <button id="openAboutBtn" class="read-btn" style="background-color: var(--success-color); color: white;">
                    <i class="fas fa-info-circle"></i> ${currentLanguage === 'myanmar' ? 'App အကြောင်း' : 'About'}
                </button>
            </div>
        </div>
    `;
    
    // Attach event listeners after rendering
    document.getElementById('openSettingsBtn').addEventListener('click', () => settingsModal.style.display = 'block');
    document.getElementById('openAboutBtn').addEventListener('click', () => {
        // Ensure About Modal content is translated before opening
        createAboutModal(); 
        aboutModal.style.display = 'block';
    });
}


// --- 13. Settings Component Logic (Uses elements defined in Section 1) ---

// 1. Dark Mode Toggle
if (darkModeToggle) {
    darkModeToggle.addEventListener('change', function() {
        if (this.checked) {
            appFrame.classList.add('dark-mode');
            localStorage.setItem('darkMode', 'enabled');
        } else {
            appFrame.classList.remove('dark-mode');
            localStorage.setItem('darkMode', 'disabled');
        }
    });
}

// 2. Language Change
if (languageSelect) {
    languageSelect.addEventListener('change', function() {
        currentLanguage = this.value;
        
        // Update About Modal Text (ensure it is created first)
        createAboutModal();
        
        localStorage.setItem('language', currentLanguage);
        
        // Re-render the current page to display new language text
        // Find the currently active button and trigger its action
        const activeBtn = document.querySelector('.nav-btn.active');
        const target = activeBtn ? activeBtn.getAttribute('data-target') : 'home';
        handleNavigation(target); 
    });
}

// 3. Font Size Slider (V2.0 Advanced Feature)
if (fontSizeSlider) {
    fontSizeSlider.addEventListener('input', function() {
        const size = this.value;
        // Set CSS Variable on the root element
        document.documentElement.style.setProperty('--base-font-size', size + 'px');
        localStorage.setItem('fontSize', size);
    });
}


// --- 14. Final Initialization Call ---
document.addEventListener('DOMContentLoaded', initializeApp);

// Export/make available filtering functions globally for inline HTML (like search input oninput)
window.filterBooks = filterBooks; 
window.filterByCategory = filterByCategory;
